# Arquitectura de Servicios SmartEdify

**Versi√≥n**: 2.0  
**Fecha**: 2025-01-01  
**Estado**: ‚úÖ Actualizado con implementaciones  

## Visi√≥n General

SmartEdify implementa una arquitectura de microservicios distribuida, organizada en capas funcionales que garantizan escalabilidad, seguridad y mantenibilidad. Cada servicio tiene responsabilidades espec√≠ficas y se comunica a trav√©s de protocolos est√°ndar.

## Estructura de Servicios por Capas

### üèõÔ∏è **Capa de Gobernanza** (`services/governance/`)

#### Governance Service v3.2.2 (Puerto 3011) ‚úÖ
- **Responsabilidad**: Orquestaci√≥n del ciclo de vida de asambleas
- **Estado**: Implementado completamente
- **Tecnolog√≠as**: NestJS, PostgreSQL, Kafka, Redis
- **Integraciones**: streaming-service, compliance-service, identity-service

#### Streaming Service v2.2.0 (Puerto 3014) ‚úÖ  
- **Responsabilidad**: Gesti√≥n de sesiones de video y validaci√≥n de asistencia
- **Estado**: Implementado completamente
- **Tecnolog√≠as**: NestJS, PostgreSQL, Socket.IO, S3, STT APIs
- **Integraciones**: governance-service, identity-service, tenancy-service

#### Compliance Service (Puerto 3012) ‚ö†Ô∏è
- **Responsabilidad**: Motor de pol√≠ticas y cumplimiento normativo
- **Estado**: Pendiente implementaci√≥n
- **Dependientes**: governance-service (cr√≠tico)

#### Reservation Service (Puerto 3013) ‚ö†Ô∏è
- **Responsabilidad**: Gesti√≥n de reservas de √°reas comunes
- **Estado**: Pendiente implementaci√≥n

### üîê **Capa Core** (`services/core/`)

#### Identity Service (Puerto 3001) ‚ö†Ô∏è
- **Responsabilidad**: Autenticaci√≥n, autorizaci√≥n, tokens contextuales
- **Estado**: Estructura b√°sica, pendiente endpoints espec√≠ficos
- **Dependientes**: streaming-service, governance-service

#### User Profiles Service (Puerto 3002) ‚ö†Ô∏è
- **Responsabilidad**: Gesti√≥n de perfiles y roles por condominio
- **Estado**: Pendiente implementaci√≥n
- **Dependientes**: streaming-service

#### Tenancy Service (Puerto 3003) ‚ö†Ô∏è
- **Responsabilidad**: Gesti√≥n de condominios y l√≠mites por tenant
- **Estado**: Pendiente implementaci√≥n
- **Dependientes**: streaming-service, governance-service

#### Notifications Service (Puerto 3005) ‚ö†Ô∏è
- **Responsabilidad**: Notificaciones multi-canal y Event Schema Registry
- **Estado**: Pendiente implementaci√≥n

#### Documents Service (Puerto 3006) ‚ö†Ô∏è
- **Responsabilidad**: Gesti√≥n documental y firma electr√≥nica
- **Estado**: Pendiente implementaci√≥n
- **Dependientes**: governance-service

### üè¢ **Capa de Operaciones** (`services/operations/`)

#### Asset Management Service (Puerto 3010) ‚ö†Ô∏è
- **Responsabilidad**: Gesti√≥n de activos y mantenimiento
- **Estado**: Implementaci√≥n parcial disponible

#### Finance Service (Puerto 3007) ‚ö†Ô∏è
- **Responsabilidad**: Gesti√≥n financiera y cuotas
- **Estado**: Pendiente implementaci√≥n

#### Physical Security Service (Puerto 3004) ‚ö†Ô∏è
- **Responsabilidad**: Control de acceso y CCTV
- **Estado**: Pendiente implementaci√≥n

### üìä **Capa de Negocio** (`services/business/`)

#### Analytics Service (Puerto 3016) ‚ö†Ô∏è
- **Responsabilidad**: Business Intelligence y Machine Learning
- **Estado**: Pendiente implementaci√≥n

#### Marketplace Service (Puerto 3015) ‚ö†Ô∏è
- **Responsabilidad**: Ecosistema de servicios premium
- **Estado**: Pendiente implementaci√≥n

---

## Patrones Arquitect√≥nicos Implementados

### üîÑ **Event-Driven Architecture**
```mermaid
graph LR
    GS[Governance Service] -->|Events| K[Kafka]
    SS[Streaming Service] -->|Events| K
    K -->|Events| AS[Analytics Service]
    K -->|Events| NS[Notifications Service]
```

**Eventos Implementados**:
- `assembly.*.v1` - Ciclo de vida de asambleas
- `session.*.v1` - Gesti√≥n de sesiones de video
- `attendance.*.v1` - Validaci√≥n de asistencia
- `transcript.*.v1` - Transcripci√≥n en tiempo real

### üõ°Ô∏è **Multi-Tenancy con RLS**
```sql
-- Implementado en governance-service y streaming-service
ALTER TABLE assemblies ENABLE ROW LEVEL SECURITY;
CREATE POLICY tenant_isolation ON assemblies 
USING (tenant_id = current_setting('app.tenant_id')::uuid);
```

### üîê **Seguridad por Capas**
```mermaid
graph TD
    U[Usuario] -->|JWT + DPoP| G[API Gateway]
    G -->|JWT Validado| GS[Governance Service]
    GS -->|mTLS| SS[Streaming Service]
    SS -->|Service Headers| IS[Identity Service]
```

**Niveles de Autenticaci√≥n**:
- **Usuarios**: JWT + DPoP para operaciones cr√≠ticas
- **Servicios Internos**: mTLS con certificados SPIFFE
- **Servicios Externos**: Service Headers + JWT

### üìä **CQRS + Event Sourcing**
```typescript
// Implementado en governance-service
export class AssemblyAggregate {
  // Command side - Write operations
  createAssembly(command: CreateAssemblyCommand): AssemblyCreatedEvent
  activateAssembly(command: ActivateAssemblyCommand): AssemblyActivatedEvent
  
  // Event sourcing - Immutable events
  apply(event: DomainEvent): void
}

// Query side - Read projections
export class AssemblyProjection {
  findAll(filters: AssemblyFilters): Assembly[]
  getStats(tenantId: string): AssemblyStats
}
```

---

## Matriz de Integraciones

| Servicio Origen | Servicio Destino | Protocolo | Autenticaci√≥n | Estado | SLA |
|-----------------|------------------|-----------|---------------|--------|-----|
| **Governance** | **Streaming** | HTTP/mTLS | mTLS Certs | ‚úÖ | <100ms |
| **Governance** | **Compliance** | HTTP/mTLS | mTLS Certs | ‚ö†Ô∏è | <100ms |
| **Governance** | **Identity** | HTTP/REST | JWT + Headers | ‚ö†Ô∏è | <200ms |
| **Governance** | **Documents** | HTTP/mTLS | mTLS Certs | ‚ö†Ô∏è | <300ms |
| **Streaming** | **Identity** | HTTP/REST | Service Headers | ‚úÖ | <200ms |
| **Streaming** | **Governance** | HTTP/mTLS | mTLS Certs | ‚úÖ | <100ms |
| **Streaming** | **Tenancy** | HTTP/REST | Service Headers | ‚úÖ | <150ms |
| **Streaming** | **User Profiles** | HTTP/REST | Service Headers | ‚ö†Ô∏è | <200ms |

**Leyenda**:
- ‚úÖ Implementado y funcional
- ‚ö†Ô∏è Cliente implementado, pendiente servicio destino
- ‚ùå No implementado

---

## Flujos de Integraci√≥n Cr√≠ticos

### üèõÔ∏è **Flujo: Asamblea H√≠brida Completa**
```mermaid
sequenceDiagram
    participant U as Usuario
    participant G as Governance
    participant S as Streaming  
    participant I as Identity
    participant C as Compliance
    participant D as Documents
    
    Note over U,D: 1. Creaci√≥n de Asamblea
    U->>G: POST /assemblies
    G->>C: Validar pol√≠tica
    C-->>G: Pol√≠tica v√°lida
    G->>G: Crear assembly
    G->>K: assembly.created.v1
    
    Note over U,D: 2. Activaci√≥n y Sesi√≥n
    U->>G: PATCH /assemblies/{id}/activate
    G->>S: POST /sessions (mTLS)
    S-->>G: Sesi√≥n creada
    G->>G: Activar assembly
    G->>K: assembly.activated.v1
    
    Note over U,D: 3. Validaci√≥n de Asistencia
    U->>S: POST /attendance/validate-qr
    S->>I: POST /contextual-tokens/validate
    I-->>S: Token v√°lido
    S->>G: Notificar asistencia
    S->>K: attendance.validated.v1
    
    Note over U,D: 4. Votaci√≥n y Cierre
    U->>G: POST /votes/{id}/cast
    G->>G: Registrar voto
    G->>S: Actualizar qu√≥rum
    G->>S: POST /sessions/{id}/end (mTLS)
    S-->>G: Datos auditor√≠a
    G->>D: Generar acta
    G->>K: assembly.completed.v1
```

### üé• **Flujo: Validaci√≥n Multi-m√©todo**
```mermaid
graph TD
    U[Usuario] --> QR{M√©todo}
    QR -->|QR Code| S1[Streaming: validate-qr]
    QR -->|Biometr√≠a| S2[Streaming: validate-biometric]  
    QR -->|SMS/Email| S3[Streaming: validate-code]
    QR -->|Manual| S4[Streaming: register-attendee]
    
    S1 --> I1[Identity: validate-contextual-token]
    S2 --> I2[Identity: validate-biometric]
    S3 --> I3[Identity: validate-code]
    S4 --> UP[User Profiles: validate-owner]
    
    I1 --> V[Validaci√≥n Exitosa]
    I2 --> V
    I3 --> V
    UP --> V
    
    V --> SA[Session Attendee Created]
    SA --> K[Kafka: attendance.validated.v1]
```

---

## Observabilidad y Monitoreo

### üìä **M√©tricas por Servicio**

#### Governance Service
```typescript
// M√©tricas de negocio
'assemblies_created_total{tenant,type}'
'assemblies_activated_total{tenant}'
'votes_cast_total{tenant,method}'
'sessions_duration_seconds{tenant}'

// M√©tricas t√©cnicas  
'http_requests_total{method,endpoint,status}'
'http_request_duration_seconds{method,endpoint}'
'database_connections_active'
'kafka_messages_sent_total{topic}'
```

#### Streaming Service
```typescript
// M√©tricas de negocio
'sessions_started_total{tenant,modality}'
'attendance_validated_total{method}'
'transcript_chunks_emitted_total'
'recording_duration_seconds_total'

// M√©tricas t√©cnicas
'websocket_connections_active'
'video_provider_requests_total{provider}'
'transcription_latency_p95_seconds'
'recording_upload_duration_seconds'
```

### üîç **Distributed Tracing**
```typescript
// Implementado con OpenTelemetry
const tracer = trace.getTracer('smartedify-services');

// Propagaci√≥n de trace_id entre servicios
const span = tracer.startSpan('assembly.create');
span.setAttributes({
  'tenant.id': tenantId,
  'assembly.id': assemblyId,
  'user.id': userId
});
```

### üö® **Health Checks Distribuidos**
```typescript
// Implementado en ambos servicios
GET /api/v1/health - Estado general + dependencias
GET /api/v1/health/ready - Preparaci√≥n para tr√°fico
GET /api/v1/health/live - Liveness probe

// Respuesta con dependencias
{
  "status": "healthy",
  "dependencies": {
    "database": "healthy",
    "kafka": "healthy", 
    "redis": "healthy",
    "identity-service": "degraded",
    "compliance-service": "unavailable"
  }
}
```

---

## Roadmap de Implementaci√≥n

### üéØ **Sprint Actual (Enero 2025)**
- [x] Governance Service v3.2.2 - Completado
- [x] Streaming Service v2.2.0 - Completado  
- [x] Integraci√≥n bidireccional - Completado
- [ ] Identity Service endpoints espec√≠ficos
- [ ] Compliance Service MVP

### üöÄ **Pr√≥ximo Sprint (Febrero 2025)**
- [ ] Tenancy Service completo
- [ ] User Profiles Service
- [ ] Documents Service MVP
- [ ] Notifications Service b√°sico

### üìà **Q1 2025**
- [ ] Asset Management Service
- [ ] Finance Service
- [ ] Physical Security Service
- [ ] Service Mesh (Istio)

### üåü **Q2 2025**
- [ ] Analytics Service
- [ ] Marketplace Service  
- [ ] API Gateway centralizado
- [ ] Event Store dedicado

---

## Principios de Dise√±o

### üéØ **Single Responsibility Principle**
Cada servicio tiene una responsabilidad espec√≠fica y bien definida:
- **Governance**: Orquestaci√≥n de asambleas
- **Streaming**: Gesti√≥n de video y asistencia
- **Identity**: Autenticaci√≥n y autorizaci√≥n
- **Compliance**: Pol√≠ticas y cumplimiento

### üîÑ **Fail-Safe Defaults**
```typescript
// Circuit breakers con fallbacks
const fallbackLimits = {
  maxSessions: 10,
  maxParticipants: 500,
  maxBitrate: 2000000
};

// Timeouts conservadores
const serviceTimeouts = {
  identity: 5000,
  compliance: 3000,
  documents: 10000
};
```

### üìä **Data Consistency**
- **Strong Consistency**: Dentro de cada servicio (ACID)
- **Eventual Consistency**: Entre servicios (Event Sourcing)
- **Compensating Actions**: Para rollback distribuido

### üõ°Ô∏è **Security by Design**
- **Zero Trust**: Toda comunicaci√≥n autenticada
- **Least Privilege**: Permisos m√≠nimos necesarios
- **Defense in Depth**: M√∫ltiples capas de seguridad

---

## Conclusiones

### ‚úÖ **Estado Actual**
- **2 servicios** completamente implementados y funcionales
- **Integraci√≥n bidireccional** entre governance y streaming
- **Arquitectura s√≥lida** preparada para escalamiento
- **Patrones enterprise** correctamente implementados

### üéØ **Pr√≥ximos Pasos**
1. **Completar servicios core** (identity, tenancy, compliance)
2. **Implementar API Gateway** centralizado
3. **Configurar Service Mesh** para comunicaci√≥n segura
4. **Agregar monitoreo** distribuido completo

### üöÄ **Visi√≥n a Largo Plazo**
SmartEdify est√° construido sobre una arquitectura moderna y escalable que soportar√° el crecimiento internacional de la plataforma, manteniendo altos est√°ndares de seguridad, observabilidad y mantenibilidad.

---

**Documento mantenido por**: Equipo de Arquitectura SmartEdify  
**√öltima actualizaci√≥n**: 2025-01-01  
**Pr√≥xima revisi√≥n**: 2025-02-01